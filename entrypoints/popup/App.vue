<template>
  <div class=" bg-gray-50 p-4 w-104 ">
    <div class="max-w-2xl mx-auto">
      <!-- Simplified Header -->
      <div class="mb-4">
        <div class="p-0">
          <div class="flex items-center gap-6">
            <!-- Logo Container -->
            <div class="w-36 h-20  rounded-xl flex items-center justify-center border border-gray-200 bg-white">
              <svg class="w-32 h-auto" viewBox="0 0 2242 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M800.97 358.735L748.852 389.637C739.108 372.715 729.824 361.678 721 356.528C711.808 350.642 699.951 347.699 685.427 347.699C667.595 347.699 652.796 352.757 641.03 362.874C629.265 372.806 623.382 385.314 623.382 400.397C623.382 421.182 638.824 437.92 669.709 450.612L712.176 467.994C746.737 481.973 772.015 499.079 788.009 519.312C804.003 539.361 812 564.009 812 593.255C812 632.433 798.947 664.806 772.842 690.373C746.554 716.124 713.922 729 674.948 729C637.997 729 607.48 718.056 583.397 696.167C559.682 674.279 544.883 643.469 539 603.739L604.079 589.392C607.02 614.407 612.168 631.697 619.521 641.262C632.758 659.656 652.061 668.853 677.43 668.853C697.469 668.853 714.106 662.139 727.342 648.712C740.579 635.284 747.197 618.27 747.197 597.669C747.197 589.392 746.002 581.851 743.612 575.045C741.406 568.055 737.821 561.71 732.858 556.007C728.078 550.122 721.827 544.695 714.106 539.729C706.385 534.579 697.193 529.705 686.53 525.106L645.442 508C587.166 483.352 558.027 447.301 558.027 399.845C558.027 367.84 570.253 341.077 594.703 319.557C619.154 297.852 649.579 287 685.979 287C735.064 287 773.394 310.912 800.97 358.735Z"
                  fill="#374151" />
                <path
                  d="M690.85 247.422L526.952 520.585L690.85 629.85V811.958H272V739.115L417.687 484.163L272 374.898V211H690.85V247.422Z"
                  fill="#FF6D34" />
                <path
                  d="M800.382 358.697L748.283 389.57C738.544 372.663 729.263 361.637 720.443 356.491C711.254 350.611 699.401 347.67 684.883 347.67C667.058 347.67 652.264 352.724 640.503 362.831C628.742 372.755 622.861 385.251 622.861 400.32C622.861 421.086 638.298 437.809 669.171 450.489L711.622 467.855C746.17 481.821 771.438 498.912 787.426 519.126C803.414 539.157 811.408 563.782 811.408 593.001C811.408 632.144 798.36 664.487 772.265 690.031C745.986 715.759 713.367 728.622 674.409 728.622C637.471 728.622 606.965 717.688 582.892 695.82C559.186 673.951 544.392 643.17 538.512 603.476L603.566 589.142C606.506 614.135 611.652 631.409 619.002 640.965C632.234 659.342 651.529 668.53 676.889 668.53C696.92 668.53 713.551 661.823 726.783 648.407C740.014 634.992 746.63 617.994 746.63 597.412C746.63 589.142 745.435 581.608 743.046 574.808C740.841 567.825 737.257 561.485 732.296 555.788C727.518 549.908 721.269 544.486 713.551 539.525C705.833 534.379 696.644 529.509 685.986 524.915L644.914 507.825C586.659 483.2 557.532 447.181 557.532 399.769C557.532 367.793 569.752 341.055 594.194 319.554C618.635 297.869 649.048 287.027 685.435 287.027C734.501 287.027 772.817 310.917 800.382 358.697Z"
                  fill="#374151" />
                <path
                  d="M950.888 510.305V720.904H888.866V510.305H862.404V452.418H888.866V354.01H950.888V452.418H999.127V510.305H950.888Z"
                  fill="#374151" />
                <path
                  d="M1244.18 452.418H1306.48V720.904H1244.18V692.788C1218.64 716.677 1191.17 728.622 1161.76 728.622C1124.64 728.622 1093.95 715.207 1069.69 688.377C1045.62 660.996 1033.58 626.815 1033.58 585.834C1033.58 545.589 1045.62 512.051 1069.69 485.221C1093.77 458.391 1123.91 444.976 1160.11 444.976C1191.35 444.976 1219.37 457.84 1244.18 483.567V452.418ZM1096.98 585.834C1096.98 611.562 1103.88 632.512 1117.66 648.683C1131.81 665.039 1149.63 673.216 1171.13 673.216C1194.11 673.216 1212.67 665.314 1226.82 649.51C1240.97 633.155 1248.04 612.389 1248.04 587.213C1248.04 562.036 1240.97 541.27 1226.82 524.915C1212.67 508.927 1194.29 500.933 1171.69 500.933C1150.37 500.933 1132.54 509.019 1118.21 525.191C1104.06 541.546 1096.98 561.761 1096.98 585.834Z"
                  fill="#374151" />
                <path
                  d="M1446.79 867H1384.77V452.418H1446.79V481.638C1471.23 457.196 1498.98 444.976 1530.03 444.976C1566.97 444.976 1597.39 458.575 1621.28 485.772C1645.53 512.786 1657.66 546.875 1657.66 588.04C1657.66 628.285 1645.62 661.823 1621.55 688.653C1597.66 715.299 1567.52 728.622 1531.14 728.622C1499.71 728.622 1471.6 716.034 1446.79 690.858V867ZM1594.26 588.315C1594.26 562.588 1587.28 541.638 1573.31 525.466C1559.16 509.111 1541.34 500.933 1519.84 500.933C1497.05 500.933 1478.58 508.835 1464.43 524.639C1450.28 540.444 1443.2 561.209 1443.2 586.937C1443.2 612.113 1450.28 632.879 1464.43 649.234C1478.4 665.222 1496.77 673.216 1519.56 673.216C1541.06 673.216 1558.79 665.13 1572.76 648.959C1587.09 632.787 1594.26 612.573 1594.26 588.315Z"
                  fill="#374151" />
                <path
                  d="M1967.77 601.271H1775.37C1777.02 623.323 1784.19 640.873 1796.87 653.921C1809.55 666.784 1825.81 673.216 1845.66 673.216C1861.09 673.216 1873.87 669.541 1883.97 662.19C1893.9 654.839 1905.2 641.241 1917.88 621.393L1970.25 650.613C1962.17 664.395 1953.62 676.248 1944.62 686.172C1935.61 695.912 1925.96 703.997 1915.67 710.429C1905.38 716.677 1894.26 721.272 1882.32 724.212C1870.37 727.152 1857.42 728.622 1843.45 728.622C1803.39 728.622 1771.23 715.759 1746.97 690.031C1722.72 664.12 1710.59 629.755 1710.59 586.937C1710.59 544.486 1722.35 510.122 1745.87 483.843C1769.58 457.931 1801 444.976 1840.14 444.976C1879.65 444.976 1910.89 457.564 1933.87 482.74C1956.65 507.733 1968.05 542.373 1968.05 586.661L1967.77 601.271ZM1904.1 550.551C1895.46 517.472 1874.6 500.933 1841.52 500.933C1833.99 500.933 1826.91 502.128 1820.3 504.517C1813.68 506.722 1807.62 510.03 1802.1 514.44C1796.77 518.667 1792.18 523.812 1788.32 529.877C1784.46 535.941 1781.52 542.833 1779.5 550.551H1904.1Z"
                  fill="#374151" />
              </svg>
            </div>

            <!-- Title Section -->
            <div class="flex-1 min-w-0">
              <div class="flex-1">
                <h1 class="text-3xl font-bold text-gray-900 tracking-tight">
                  GTM Helper
                </h1>
                <span class="text-xs italic text-gray-400">v3.0.0-beta0</span>
                <div class="bg-blue-400 p-1 font-bold rounded text-white">GTM UI: DETECTED</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings List -->
      <div class="bg-white/80 rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="divide-y divide-gray-100 ">
          <div v-for="(feature, key) in settings.features" :key="key" :class="[
            'flex items-center justify-between px-3 py-1.5 ',

          ]">
            <div class="flex items-center gap-4 flex-1">
              <div class="flex  min-w-0 flex-1" :class="compactMode ? '' : 'flex-col'">
                <div class="flex items-center gap-3 mb-1">
                  <h3 class="text-base font-semibold text-gray-900">
                    {{ getFeatureTitle(key) }}
                  </h3>
                </div>
                <div v-if="!compactMode">
                  <p class="text-xs text-gray-600 leading-relaxed">
                    {{ feature.description }}
                  </p>

                </div>
                <div else class="flex mx-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                    <path d="M12 17h.01" />
                  </svg>

                </div>

              </div>
            </div>

            <!-- Enhanced Toggle Switch -->
            <div class="ml-4">
              <button @click="toggleSetting(key)" class="relative rounded-full transition-all duration-200"
                type="button" :aria-label="`Toggle ${getFeatureTitle(key)}`">
                <div :class="[
                  'w-12 h-6 rounded-full transition-all duration-500 ease-in-out relative',
                  feature.enabled
                    ? 'bg-[#FF6D34] shadow-md'
                    : 'bg-gray-300'
                ]">
                  <!-- Inner track highlight for enabled state -->
                  <div v-if="feature.enabled" class="absolute inset-0.5 rounded-full"></div>
                </div>

                <div :class="[
                  'absolute top-0.5 w-5 h-5 rounded-full bg-white shadow-lg transform transition-all duration-500 ease-in-out flex items-center justify-center',
                  feature.enabled ? 'translate-x-6 left-0.5' : 'translate-x-0 left-0.5'
                ]">
                  <!-- Smooth checkmark animation -->
                  <svg :class="[
                    'w-3.5 h-3.5 text-orange-500 transition-all duration-300',
                    feature.enabled ? 'opacity-100 scale-100' : 'opacity-0 scale-75'
                  ]" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Feature Request Footer -->
      <div class="mt-4">
        <button @click="openFeatureRequest"
          class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-white border border-gray-200 rounded-2xl text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 hover:border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Request a new feature
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed, watch } from 'vue'

const settings = reactive({
  features: {
    jsonFormatter: {
      description: 'Show beautified JSON of incoming/outgoing requests in sGTM preview',
      enabled: false,
      activableOn: ["GTMTASS"]
    },
    urlFormatter: {
      description: 'Show beautified URL parameters of incoming/outgoing requests in sGTM preview.',
      enabled: false,
      activableOn: ["GTMTASS"]
    },
    tagTypesColouring: {
      description: 'Add colored indicators for different tag types. E.g. Orange for GA4 for web & server GTM preview.',
      enabled: false,
      activableOn: ["GTMUI", "GTMTA", "GTMTASS"]
    },
    tagStatusColouring: {
      description: 'Highlight failed tag statuses in red for web & server GTM preview.',
      enabled: false,
      activableOn: ["GTMUI", "GTMTA", "GTMTASS"]
    },
    consentStatusReporting: {
      description: 'Highlight consent status in sGTM preview based on gcs for GA4 requests and consent_state for Data tag requests.',
      enabled: false,
      activableOn: ["GTMTASS"]
    },
    entitiesFilteringPreview: {
      description: 'Filter Tags and variables on preview mode.',
      enabled: false,
      activableOn: ["GTMTA", "GTMTASS"]
    },
    entitiesFiltering: {
      description: 'Filter Tags and variables on UI.',
      enabled: false,
      activableOn: ["GTMUI"]
    }
  }
})

// Create a computed that extracts just the enabled states
const enabledStates = computed(() => {
  const states = {};
  Object.keys(settings.features).forEach(key => {
    states[key] = settings.features[key].enabled;
  });
  return states;
});

watch(
  enabledStates,
  (newStates, oldStates) => {
    if (!oldStates) return;

    Object.keys(newStates).forEach(featureKey => {
      if (oldStates[featureKey] !== newStates[featureKey]) {
        console.log(`Feature changed: "${featureKey}" is now ${newStates[featureKey] ? 'ENABLED' : 'DISABLED'}`);
        handleFeatureChange(featureKey, newStates[featureKey]);
      }
    });
  }
);

async function handleFeatureChange(featureKey, isEnabled) {

  // Your logic here based on the specific feature and status
  if (featureKey === 'tagTypesColouring') {
    try {

      if (isEnabled) {
        chrome.tabs.query({ active: true, currentWindow: true }, async (tabs) => {
          if (tabs.length > 0) {
            const tabId = tabs[0].id;
            await browser.scripting.executeScript({
              target: { tabId },
              func: () => {
                console.log("ENABLE FEATURE")
                if (window.__stape && window.__stape.getFeature('GTMCardHighlighting')) {
                  window.__stape.getFeature('GTMCardHighlighting').enable();
                } else {
                  console.warn('StapeHelper not found or GTMCardHighlighting feature not available');
                }
              },
              world: 'MAIN'
            });
          }
        });


      } else {
        chrome.tabs.query({ active: true, currentWindow: true }, async (tabs) => {
          if (tabs.length > 0) {
            const tabId = tabs[0].id;
        await browser.scripting.executeScript({
          target: { tabId },
          func: () => {
            console.log("DISABLE FEATURE")
            if (window.__stape && window.__stape.getFeature('GTMCardHighlighting')) {
              window.__stape.getFeature('GTMCardHighlighting').disable();
            } else {
              console.warn('StapeHelper not found or GTMCardHighlighting feature not available');
            }
          },
          world: 'MAIN'
        });
          }
        });
        
        

      }
    } catch (error) {
      console.error('Failed to execute script:', error);
    }
  }
}

const activeTooltip = ref(null)

// Helper functions
const getFeatureTitle = (key) => {
  const titles = {
    jsonFormatter: 'JSON Formatter',
    urlFormatter: 'URL Formatter',
    tagTypesColouring: 'Tag Type Colors',
    tagStatusColouring: 'Tag Status Colors',
    consentStatusReporting: 'Consent Status',
    entitiesFilteringPreview: 'Preview Filtering',
    entitiesFiltering: 'UI Filtering'
  }
  return titles[key] || key
}
const activeSettingsCount = computed(() => {
  return Object.values(settings.features).filter(feature => feature.enabled).length
})
const compactMode = ref(true)
const toggleSetting = (key) => {
  settings.features[key].enabled = !settings.features[key].enabled
}

const openFeatureRequest = () => {
  window.open('https://feature.stape.io', '_blank')
}
</script>

<style scoped>
/* Enhanced switch animations */
@keyframes slideIn {
  from {
    transform: translateX(0);
  }

  to {
    transform: translateX(1.75rem);
  }
}

@keyframes slideOut {
  from {
    transform: translateX(1.75rem);
  }

  to {
    transform: translateX(0);
  }
}

/* Smooth transitions for all elements */
button {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

button:active {
  transform: scale(0.98);
}

/* Focus states */
button:focus-visible {
  outline: 2px solid #f97316;
  outline-offset: 2px;
}
</style>